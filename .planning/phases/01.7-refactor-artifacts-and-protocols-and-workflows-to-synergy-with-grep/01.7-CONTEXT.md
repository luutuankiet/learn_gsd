# Phase 1.7: Refactor Artifacts for Grep Synergy - Context

**Gathered:** 2026-01-27
**Status:** Ready for planning

<domain>
## Phase Boundary

Restructure all GSD-lite artifacts (WORK.md, STATE.md, protocols, workflows) so that key information is discoverable via single-line grep patterns. Enable non-linear retrieval — agents grep headers/tags first, then surgical read of relevant lines. WORK.md becomes perpetual (not ephemeral), with user-controlled housekeeping to archive old entries.

**This phase is about organizing content** — how information is structured, tagged, and formatted so that grep/search workflows work efficiently with `uvx fs-mcp` tools.

</domain>

<decisions>
## Implementation Decisions

### Log Entry Format
- Use `[LOG-NNN]` prefix for all log entries (sequential, zero-padded)
- Each entry includes: timestamp, type tag, task tag, summary, details with code
- **Always include code snippets** in EXEC/DISCOVERY logs — maximum context for PR extraction

### Log Type Taxonomy (6 types)
- `[VISION]` — Goals, what success looks like
- `[DECISION]` — Choices made with rationale
- `[DISCOVERY]` — Evidence, findings, data (with code snippets)
- `[PLAN]` — Strategy, approach chosen
- `[BLOCKER]` — Issues, pivots, what didn't work
- `[EXEC]` — Concrete actions taken (with code snippets)

### File Structure Changes
- **Merge STATE.md into WORK.md** — fewer files = less confusion for weak agents
- WORK.md structure:
  1. Current Understanding (handoff header)
  2. Key Events Index (grep accelerator table)
  3. Session Log (chronological, atomic entries)
- Deprecate STATE.md — remove from templates

### Multi-Task Support in WORK.md
- Each log entry tagged with Task: `[LOG-017] - [timestamp] - [VISION] - Task: MODEL-C`
- Index table includes Task column for filtering
- Current Understanding shows: Active Task + Parked tasks

### Housekeeping Workflow (Replaces Promotion)
- Single workflow handles both PR extraction AND archiving
- User triggers with natural language: "write PR for MODEL-A" or "clean up WORK.md"
- Archived entries move to HISTORY.md
- WORK.md is now **perpetual** — not deleted after promotion

### Grep Pattern Design
- All patterns are **single-line only** (simpler, more portable)
- No multiline grep required — use "grep line number → read section" workflow
- Key patterns:
  - Header discovery: `^## `
  - Log ID lookup: `^\[LOG-028\]`
  - Type filtering: `\[DECISION\]`
  - Task filtering: `Task: MODEL-A`

### Template Coherence Updates Required
- PROTOCOL.md — update file references, remove ephemeral WORK.md language
- WORK.md template — new 3-part structure
- All workflow files — update for perpetual WORK.md, merged housekeeping
- STATE.md — deprecate (merged into WORK.md)

### Testing with fs-mcp
- Create golden sample WORK.md (50-100 lines) with all log types
- Spin up `uvx fs-mcp` server, send real grep queries via stdio
- Test cases:
  1. Header discovery: `^## ` finds all section headers
  2. Log ID lookup: `[LOG-NNN]` finds specific entry
  3. Type filtering: `[DECISION]` finds all decisions
  4. Task filtering: `Task: MODEL-A` finds task-specific entries

### Claude's Discretion
- Exact formatting of the Key Events Index table
- How to handle edge cases in log ID sequencing
- Structure of HISTORY.md archive entries
- Error handling in test harness

</decisions>

<specifics>
## Specific Ideas

- "I like the verbose logging in WORK.prod.md — include code snippets, full context"
- "The goal is context condensing — fresh agent can read logs and one-shot write PR"
- "Agent should grep headers first (^## ) to discover structure, then surgical read"
- "Think of WORK.md as a simple database — grep to find, read to retrieve"
- References: WORK.prod.md (production session), suggestions.md (V2 proposal), prod_session.md (detailed session flow)

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 01.7-refactor-artifacts-and-protocols-and-workflows-to-synergy-with-grep*
*Context gathered: 2026-01-27*
